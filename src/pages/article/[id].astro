---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getArticleById, getRelatedArticles } from '../../lib/db';

const { id } = Astro.params;
const { env } = Astro.locals.runtime;
const db = env.DB;

if (!id) return Astro.redirect('/');

const article = await getArticleById(db, id);
if (!article) return Astro.redirect('/');

const tags: string[] = JSON.parse(article.tags || '[]');
const related = await getRelatedArticles(db, article, 3);

const sourceLabels: Record<string, string> = {
  hackernews: 'Hacker News',
  github: 'GitHub Trending',
  techcrunch: 'TechCrunch',
  theverge: 'The Verge',
  geeknews: '긱뉴스',
  yozm: '요즘IT',
  discoveryet: '디스커버리엣',
  cloudflare: 'Cloudflare Blog',
  reuters: 'Reuters',
  apnews: 'AP News',
  bbc: 'BBC',
  yonhap: '연합뉴스',
};

const tagColors: Record<string, string> = {
  ai: 'bg-accent-ai/15 text-accent-ai',
  frontend: 'bg-accent-web/15 text-accent-web',
  backend: 'bg-accent-infra/15 text-accent-infra',
  infra: 'bg-accent-infra/15 text-accent-infra',
  startup: 'bg-accent-startup/15 text-accent-startup',
  security: 'bg-accent-security/15 text-accent-security',
  mobile: 'bg-accent-mobile/15 text-accent-mobile',
};

const pubDate = new Date(article.published_at).toLocaleDateString('ko-KR', {
  year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit',
});
---

<BaseLayout title={`${article.title} - Tech Digest`}>
  <article class="space-y-6">
    <div>
      <a href="/" class="text-sm text-text-secondary hover:text-primary">&larr; 돌아가기</a>
    </div>

    <header class="space-y-3">
      <h1 class="text-2xl font-bold leading-tight">{article.title}</h1>
      <div class="flex flex-wrap items-center gap-3 text-sm text-text-secondary">
        <span class="font-medium">{sourceLabels[article.source] || article.source}</span>
        <span>&middot;</span>
        <span>{pubDate}</span>
        {article.score_final > 0 && (
          <>
            <span>&middot;</span>
            <span>점수 {Math.round(article.score_final)}</span>
          </>
        )}
      </div>
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => (
          <span class:list={['rounded-full px-3 py-1 text-xs font-medium', tagColors[tag] || 'bg-gray-100 text-gray-600']}>
            {tag}
          </span>
        ))}
      </div>
    </header>

    {article.summary_ko && (
      <section class="rounded-lg border border-primary/20 bg-primary/5 p-5">
        <h2 class="mb-2 text-sm font-semibold text-primary">한국어 요약</h2>
        <p class="leading-relaxed">{article.summary_ko}</p>
      </section>
    )}

    {article.insight_ko && (
      <section class="rounded-lg border border-accent-ai/20 bg-accent-ai/5 p-5">
        <h2 class="mb-2 text-sm font-semibold text-accent-ai">왜 중요한가</h2>
        <p class="leading-relaxed">{article.insight_ko}</p>
      </section>
    )}

    <div class="flex gap-3">
      <a
        href={article.url}
        target="_blank"
        rel="noopener noreferrer"
        class="rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary-dark"
      >
        원문 보기 &rarr;
      </a>
      <button
        id="bookmark-btn"
        data-article-id={article.id}
        class:list={[
          'rounded-lg border px-4 py-2 text-sm font-medium',
          article.is_bookmarked
            ? 'border-primary bg-primary/10 text-primary'
            : 'border-border text-text-secondary hover:border-primary/30',
        ]}
      >
        {article.is_bookmarked ? '북마크됨' : '북마크'}
      </button>
      <button
        id="archive-btn"
        data-article-id={article.id}
        class="rounded-lg border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:border-primary/30"
      >
        {article.status === 'archived' ? '복구' : '아카이브'}
      </button>
    </div>

    {related.length > 0 && (
      <section class="space-y-3">
        <h2 class="text-lg font-bold">관련 기사</h2>
        <div class="space-y-2">
          {related.map((r) => (
            <a
              href={`/article/${r.id}`}
              class="flex items-center gap-2 rounded-lg border border-border p-3 text-sm hover:border-primary/30"
            >
              <span class="truncate font-medium">{r.title}</span>
              <span class="shrink-0 text-xs text-text-secondary">{sourceLabels[r.source] || r.source}</span>
            </a>
          ))}
        </div>
      </section>
    )}
  </article>

  <script>
    const bookmarkBtn = document.getElementById('bookmark-btn');
    bookmarkBtn?.addEventListener('click', async () => {
      const id = (bookmarkBtn as HTMLElement).dataset.articleId;
      const res = await fetch('/api/bookmark', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ article_id: id }),
      });
      if (res.ok) location.reload();
    });

    const archiveBtn = document.getElementById('archive-btn');
    archiveBtn?.addEventListener('click', async () => {
      const id = (archiveBtn as HTMLElement).dataset.articleId;
      const isArchived = archiveBtn?.textContent?.trim() === '복구';
      const res = await fetch(`/api/article/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: isArchived ? 'active' : 'archived' }),
      });
      if (res.ok) location.reload();
    });
  </script>
</BaseLayout>
