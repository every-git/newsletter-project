---
import type { Article } from '../lib/types';

interface Props {
  article: Article;
  variant?: 'large' | 'small';
  showActions?: boolean;
}

const { article, variant = 'small', showActions = true } = Astro.props;
const tags: string[] = JSON.parse(article.tags || '[]');

const tagColors: Record<string, string> = {
  ai: 'bg-accent-ai/15 text-accent-ai',
  frontend: 'bg-accent-web/15 text-accent-web',
  backend: 'bg-accent-infra/15 text-accent-infra',
  infra: 'bg-accent-infra/15 text-accent-infra',
  startup: 'bg-accent-startup/15 text-accent-startup',
  security: 'bg-accent-security/15 text-accent-security',
  mobile: 'bg-accent-mobile/15 text-accent-mobile',
  general: 'bg-gray-100 text-gray-600',
};

const sourceLabels: Record<string, string> = {
  hackernews: 'HN',
  github: 'GitHub',
  techcrunch: 'TC',
  theverge: 'Verge',
  geeknews: '긱뉴스',
  yozm: '요즘IT',
  discoveryet: '디스커버리엣',
  cloudflare: 'CF Blog',
  reuters: 'Reuters',
  apnews: 'AP',
  bbc: 'BBC',
  yonhap: '연합',
};

const timeAgo = (dateStr: string) => {
  const diff = Date.now() - new Date(dateStr).getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  if (hours < 1) return '방금';
  if (hours < 24) return `${hours}시간 전`;
  const days = Math.floor(hours / 24);
  return `${days}일 전`;
};
---

<article class:list={[
  'group rounded-lg border border-border bg-surface p-4 transition-colors hover:border-primary/30',
  variant === 'large' ? 'flex flex-col gap-3' : 'flex flex-col gap-2',
]}>
  <div class="flex items-start justify-between gap-2">
    <a
      href={`/article/${article.id}`}
      class:list={[
        'font-medium leading-snug text-text hover:text-primary',
        variant === 'large' ? 'text-base' : 'text-sm',
      ]}
    >
      {article.title_ko || article.title}
    </a>
    {article.score_final > 0 && (
      <span class="shrink-0 text-xs font-medium text-text-secondary">
        {Math.round(article.score_final)}
      </span>
    )}
  </div>

  {article.summary_ko && (
    <p class:list={[
      'text-sm leading-relaxed text-text-secondary',
      variant === 'small' && 'line-clamp-1',
    ]}>
      {article.summary_ko}
    </p>
  )}

  <div class="flex flex-wrap items-center gap-2 text-xs">
    <span class="font-medium text-text-secondary">
      {sourceLabels[article.source] || article.source}
    </span>
    <span class="text-text-secondary/50">&middot;</span>
    <span class="text-text-secondary">{timeAgo(article.published_at)}</span>

    {tags.map((tag) => (
      <span class:list={['rounded-full px-2 py-0.5 text-[10px] font-medium', tagColors[tag] || tagColors.general]}>
        {tag}
      </span>
    ))}
  </div>

  {showActions && (
    <div class="flex gap-2 pt-1 opacity-0 transition-opacity group-hover:opacity-100">
      <button
        data-action="bookmark"
        data-article-id={article.id}
        class="text-xs text-text-secondary hover:text-primary"
        title="북마크"
      >
        &#9734;
      </button>
      <button
        data-action="archive"
        data-article-id={article.id}
        class="text-xs text-text-secondary hover:text-primary"
        title="아카이브"
      >
        &#128230;
      </button>
      <button
        data-action="delete"
        data-article-id={article.id}
        class="text-xs text-text-secondary hover:text-red-500"
        title="삭제"
      >
        &#128465;
      </button>
      <a
        href={article.url}
        target="_blank"
        rel="noopener noreferrer"
        class="text-xs text-text-secondary hover:text-primary"
        title="원문 보기"
      >
        &#8599;
      </a>
    </div>
  )}
</article>

<script>
  document.addEventListener('click', async (e) => {
    const btn = (e.target as HTMLElement).closest<HTMLButtonElement>('[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const articleId = btn.dataset.articleId;
    if (!articleId) return;

    const card = btn.closest('article');

    try {
      if (action === 'bookmark') {
        const res = await fetch('/api/bookmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ article_id: articleId }),
        });
        const data = await res.json();
        if (data.ok) {
          btn.innerHTML = data.is_bookmarked ? '&#9733;' : '&#9734;';
        }
      } else if (action === 'archive') {
        const res = await fetch(`/api/article/${articleId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'archived' }),
        });
        const data = await res.json();
        if (data.ok && card) {
          card.style.transition = 'opacity 0.3s, transform 0.3s';
          card.style.opacity = '0';
          card.style.transform = 'translateX(-20px)';
          setTimeout(() => card.remove(), 300);
        }
      } else if (action === 'delete') {
        if (!confirm('이 기사를 삭제하시겠습니까?')) return;
        const res = await fetch(`/api/article/${articleId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'deleted' }),
        });
        const data = await res.json();
        if (data.ok && card) {
          card.style.transition = 'opacity 0.3s, transform 0.3s';
          card.style.opacity = '0';
          card.style.transform = 'translateX(-20px)';
          setTimeout(() => card.remove(), 300);
        }
      }
    } catch (err) {
      console.error(`Action "${action}" failed:`, err);
    }
  });
</script>
