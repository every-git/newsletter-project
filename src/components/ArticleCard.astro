---
import type { Article } from '../lib/types';

interface Props {
  article: Article;
  variant?: 'large' | 'small';
  showActions?: boolean;
}

const { article, variant = 'small', showActions = true } = Astro.props;
const tags: string[] = JSON.parse(article.tags || '[]');

const tagColors: Record<string, string> = {
  ai: 'bg-accent-ai/15 text-accent-ai',
  frontend: 'bg-accent-web/15 text-accent-web',
  backend: 'bg-accent-infra/15 text-accent-infra',
  infra: 'bg-accent-infra/15 text-accent-infra',
  startup: 'bg-accent-startup/15 text-accent-startup',
  security: 'bg-accent-security/15 text-accent-security',
  mobile: 'bg-accent-mobile/15 text-accent-mobile',
  general: 'bg-gray-100 text-gray-600',
};

const sourceLabels: Record<string, string> = {
  hackernews: 'HN',
  github: 'GitHub',
  techcrunch: 'TC',
  theverge: 'Verge',
  geeknews: '긱뉴스',
  yozm: '요즘IT',
  discoveryet: '디스커버리엣',
  cloudflare: 'CF Blog',
  reuters: 'Reuters',
  apnews: 'AP',
  bbc: 'BBC',
  yonhap: '연합',
};

const timeAgo = (dateStr: string) => {
  const diff = Date.now() - new Date(dateStr).getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  if (hours < 1) return '방금';
  if (hours < 24) return `${hours}시간 전`;
  const days = Math.floor(hours / 24);
  return `${days}일 전`;
};
---

<article class:list={[
  'group rounded-lg border border-border bg-surface p-4 transition-colors hover:border-primary/30',
  variant === 'large' ? 'flex flex-col gap-3' : 'flex flex-col gap-2',
]}>
  <div class="flex items-start justify-between gap-2">
    <a
      href={`/article/${article.id}`}
      class:list={[
        'font-medium leading-snug text-text hover:text-primary',
        variant === 'large' ? 'text-base' : 'text-sm',
      ]}
    >
      {article.title}
    </a>
    {article.score_final > 0 && (
      <span class="shrink-0 text-xs font-medium text-text-secondary">
        {Math.round(article.score_final)}
      </span>
    )}
  </div>

  {variant === 'large' && article.summary_ko && (
    <p class="text-sm leading-relaxed text-text-secondary">
      {article.summary_ko}
    </p>
  )}

  <div class="flex flex-wrap items-center gap-2 text-xs">
    <span class="font-medium text-text-secondary">
      {sourceLabels[article.source] || article.source}
    </span>
    <span class="text-text-secondary/50">&middot;</span>
    <span class="text-text-secondary">{timeAgo(article.published_at)}</span>

    {tags.map((tag) => (
      <span class:list={['rounded-full px-2 py-0.5 text-[10px] font-medium', tagColors[tag] || tagColors.general]}>
        {tag}
      </span>
    ))}
  </div>

  {showActions && (
    <div class="flex gap-2 pt-1 opacity-0 transition-opacity group-hover:opacity-100">
      <button
        data-action="bookmark"
        data-article-id={article.id}
        class="text-xs text-text-secondary hover:text-primary"
        title="북마크"
      >
        &#9734;
      </button>
      <a
        href={article.url}
        target="_blank"
        rel="noopener noreferrer"
        class="text-xs text-text-secondary hover:text-primary"
        title="원문 보기"
      >
        &#8599;
      </a>
    </div>
  )}
</article>
